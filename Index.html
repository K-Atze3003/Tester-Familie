<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FamilyHub Pro v3</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #f2f2f7; /* iOS Light Gray Background */
            --primary-blue: #007aff;
            --success-green: #34c759;
            --danger-red: #ff3b30;
            --info-blue: #5ac8fa;
            --card-bg: #ffffff;
            --text-color: #1c1c1e;
            --tab-bar-bg: rgba(255, 255, 255, 0.92);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding-bottom: 110px; /* Platz f√ºr TabBar */
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- LAYOUT COMPONENTS --- */
        section { display: none; padding: 20px; animation: fadeIn 0.3s ease; flex-direction: column; align-items: center; }
        section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { margin-top: 40px; font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 20px; letter-spacing: -0.5px; }
        h3 { width: 100%; margin-top: 25px; margin-bottom: 10px; font-size: 13px; text-transform: uppercase; color: #8e8e93; font-weight: 600; padding-left: 10px; }

        /* --- CARDS & LISTS --- */
        .card-container { width: 100%; background: var(--card-bg); border-radius: 12px; padding: 0 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); box-sizing: border-box; margin-bottom: 10px; overflow: hidden; }
        .card-padded { padding: 15px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #e5e5ea; }
        .list-item:last-child { border-bottom: none; }
        
        /* --- FORMS & INPUTS --- */
        input, select, textarea {
            width: 100%; padding: 12px; margin: 5px 0 15px 0; border: 1px solid #d1d1d6; border-radius: 10px;
            font-size: 16px; box-sizing: border-box; background: #fff; font-family: inherit; appearance: none;
        }
        button.action-btn {
            width: 100%; padding: 14px; background: var(--primary-blue); color: white; border: none;
            border-radius: 12px; font-size: 17px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        button.action-btn:active { opacity: 0.8; }
        
        /* Buttons klein */
        button.sm-btn { padding: 6px 12px; border-radius: 15px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; }
        .btn-delete { background: rgba(255, 59, 48, 0.1); color: var(--danger-red); }
        .btn-done { background: rgba(52, 199, 89, 0.1); color: var(--success-green); }

        /* --- ROUTINE GRID --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .routine-card { background: white; border-radius: 20px; height: 110px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.2s; font-weight: 600; color: #333; }
        .routine-card.done { background: var(--success-green); color: white; transform: scale(0.96); box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        .routine-card .icon { font-size: 38px; margin-bottom: 8px; }
        .progress-bar-bg { width: 100%; height: 12px; background: #e5e5ea; border-radius: 6px; overflow: hidden; margin-bottom: 25px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-blue), #5ac8fa); width: 0%; transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1); }

        /* --- TASKS STYLING --- */
        .task-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--primary-blue); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .task-title { font-weight: 600; font-size: 16px; }
        .badge { font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: 700; text-transform: uppercase; background: #f2f2f7; color: #666; }
        .task-meta { font-size: 12px; color: #8e8e93; display: flex; align-items: center; gap: 5px; }
        .task-actions { margin-top: 12px; display: flex; justify-content: flex-end; gap: 10px; }

        /* --- NAV BAR --- */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 85px; background: var(--tab-bar-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; border-top: 0.5px solid #c6c6c8; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #999; font-size: 10px; text-decoration: none; width: 20%; padding-top: 5px; transition: color 0.2s; }
        .tab-item.active { color: var(--primary-blue); }
        .tab-item i { font-size: 24px; margin-bottom: 4px; }

        /* --- EXTRAS --- */
        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none; }
        #videoOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:5000; justify-content:center; align-items:center; flex-direction:column; color: white; }
        
        .trash-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    </style>
</head>
<body>

    <audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="snd-success" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <section id="routine" class="active">
        <h1>Gute Nacht! üåô</h1>
        <div class="progress-bar-bg"><div id="progress-fill" class="progress-fill"></div></div>
        
        <div class="grid">
            <div class="routine-card" onclick="toggleRoutine(this)"><span class="icon">üçé</span><span>Abendbrot</span></div>
            <div class="routine-card" onclick="toggleRoutine(this)"><span class="icon">üß∏</span><span>Aufr√§umen</span></div>
            <div class="routine-card" onclick="toggleRoutine(this)"><span class="icon">ü™•</span><span>Z√§hne</span></div>
            <div class="routine-card" onclick="toggleRoutine(this)"><span class="icon">üëö</span><span>Schlafanzug</span></div>
            <div class="routine-card" onclick="toggleRoutine(this)"><span class="icon">üìñ</span><span>Vorlesen</span></div>    
            <div class="routine-card" onclick="toggleRoutine(this)"><span class="icon">üò¥</span><span>Schlafen</span></div>
        </div>
        
        <button onclick="resetRoutine()" style="margin-top:30px; background:none; border:none; color:#8e8e93; font-size:14px;">Routine zur√ºcksetzen</button>
    </section>

    <div id="videoOverlay" onclick="this.style.display='none'">
        <video id="rewardVideo" width="90%" playsinline>
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
        </video>
        <h2 style="margin-top:20px;">Super gemacht! üéâ</h2>
    </div>

    <section id="calendar">
        <h1>Kalender üìÖ</h1>
        
        <div id="trashDisplay" style="width: 100%;"></div>
        
        <h3>Geburtstage üéÇ</h3>
        <div class="card-container" id="birthdayList">
            </div>

        <h3>Aufgaben heute</h3>
        <div class="card-container card-padded" id="todayTasksPreview" style="color:#666; font-size:14px; text-align:center;">
            Keine Aufgaben f√ºr heute f√§llig.
        </div>
    </section>

    <section id="tasks">
        <h1>Aufgaben ‚úÖ</h1>
        
        <div class="card-container card-padded">
            <h4 style="margin:0 0 10px 0; font-size:15px;">Neue Aufgabe erstellen</h4>
            <div style="display:flex; gap:10px;">
                <input type="text" id="taskCreator" placeholder="Von (z.B. Mama)">
                <select id="taskAssignee">
                    <option value="" disabled selected>F√ºr wen?</option>
                    <option>Mama</option>
                    <option>Papa</option>
                    <option>Kind 1</option>
                    <option>Kind 2</option>
                    <option>Alle</option>
                </select>
            </div>
            <input type="date" id="taskDate">
            <textarea id="taskText" rows="2" placeholder="Was ist zu tun? (z.B. Sp√ºlmaschine)"></textarea>
            <button class="action-btn" onclick="createTask()"><i class="fas fa-plus"></i> Erstellen</button>
        </div>

        <h3>Offene Aufgaben</h3>
        <div id="taskListContainer" style="width: 100%;"></div>
    </section>

    <section id="contacts">
        <h1>Kontakte üìû</h1>
        <div class="card-container card-padded">
            <button class="action-btn" onclick="openContactModal()" style="background:#e5e5ea; color:#333;">+ Neuer Kontakt</button>
        </div>
        <div id="contactsList" style="width: 100%;"></div>
    </section>

    <section id="settings">
        <h1>Einstellungen ‚öôÔ∏è</h1>
        
        <div class="card-container card-padded">
            <h4 style="margin-top:0;">üìÇ M√ºllkalender Import</h4>
            <p style="font-size:13px; color:#666;">Filter f√ºr .ics Import (Kommagetrennt):</p>
            <input type="text" id="filterInput" placeholder="z.B. Restm√ºll, Bio, Papier" onchange="saveFilter()">
            
            <input type="file" id="icsInput" style="display:none" accept=".ics" onchange="importIcs(event)">
            <label for="icsInput" class="action-btn" style="background:#e5e5ea; color:#007aff; margin-top:10px;">
                <i class="fas fa-file-import"></i> ICS Datei w√§hlen
            </label>
            <div id="importStatus" style="margin-top:10px; font-size:12px; color:var(--success-green); text-align:center;"></div>
        </div>

        <div class="card-container">
            <div class="list-item" style="padding: 15px;">
                <div>
                    <strong>Aufgaben l√∂schen</strong><br>
                    <small style="color:#8e8e93;">Alle Tasks aus dem Dashboard</small>
                </div>
                <button class="sm-btn btn-delete" onclick="deleteCategory('familyTasks', 'Aufgaben')">L√∂schen</button>
            </div>

            <div class="list-item" style="padding: 15px;">
                <div>
                    <strong>Kontakte l√∂schen</strong><br>
                    <small style="color:#8e8e93;">Adressbuch & Geburtstage</small>
                </div>
                <button class="sm-btn btn-delete" onclick="deleteCategory('familyContacts', 'Kontakte')">L√∂schen</button>
            </div>

            <div class="list-item" style="padding: 15px;">
                <div>
                    <strong>Kalenderdaten l√∂schen</strong><br>
                    <small style="color:#8e8e93;">Importierte M√ºlltermine</small>
                </div>
                <button class="sm-btn btn-delete" onclick="deleteCategory('trashData', 'Kalender')">L√∂schen</button>
            </div>

            <div class="list-item" style="padding: 15px; border-top: 1px solid #d1d1d6;">
                <div style="color:var(--danger-red);">
                    <strong>ALLES ZUR√úCKSETZEN</strong><br>
                    <small>App auf Werkszustand</small>
                </div>
                <button class="sm-btn" style="background:var(--danger-red); color:white;" onclick="deleteCategory('ALL', 'ALLE DATEN')">RESET</button>
            </div>
        </div>
        
        <div style="text-align:center; color:#ccc; font-size:10px; margin-top:20px;">FamilyApp Prototype v3.0</div>
    </section>

    <nav class="tab-bar">
        <a href="#" class="tab-item active" onclick="nav('routine', this)">
            <i class="fas fa-child"></i><span>Routine</span>
        </a>
        <a href="#" class="tab-item" onclick="nav('calendar', this)">
            <i class="fas fa-calendar-alt"></i><span>Kalender</span>
        </a>
        <a href="#" class="tab-item" onclick="nav('tasks', this)">
            <i class="fas fa-check-circle"></i><span>Aufgaben</span>
        </a>
        <a href="#" class="tab-item" onclick="nav('contacts', this)">
            <i class="fas fa-address-book"></i><span>Kontakte</span>
        </a>
        <a href="#" class="tab-item" onclick="nav('settings', this)">
            <i class="fas fa-cog"></i><span>Optionen</span>
        </a>
    </nav>

    <script>
        const DELETE_PIN = "2410";

        // --- NAVIGATION & INIT ---
        function nav(id, el) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            
            // Refresh logic when tab is opened
            if(id === 'calendar') { renderTrash(); renderBirthdays(); updateTodayPreview(); }
            if(id === 'contacts') { renderContacts(); }
            if(id === 'tasks') { renderTasks(); }
        }

        window.onload = function() {
            document.getElementById('filterInput').value = localStorage.getItem('trashFilter') || "Restm√ºll, Bio, Papier, Gelb";
            // Set default date to today
            document.getElementById('taskDate').valueAsDate = new Date();
        };

        // --- 1. ROUTINE LOGIK ---
        function toggleRoutine(el) {
            const isDone = el.classList.toggle('done');
            playSound(isDone ? 'snd-click' : null);
            
            const total = document.querySelectorAll('.routine-card').length;
            const done = document.querySelectorAll('.routine-card.done').length;
            document.getElementById('progress-fill').style.width = (done/total*100) + "%";

            if(done === total && done > 0) {
                playSound('snd-success');
                showReward();
            }
        }

        function showReward() {
            const overlay = document.getElementById('videoOverlay');
            const video = document.getElementById('rewardVideo');
            overlay.style.display = 'flex';
            video.play();
            setTimeout(() => { overlay.style.display = 'none'; video.pause(); }, 6000);
        }

        function resetRoutine() {
            document.querySelectorAll('.routine-card').forEach(c => c.classList.remove('done'));
            document.getElementById('progress-fill').style.width = "0%";
        }
        
        function playSound(id) {
            if(!id) return;
            const audio = document.getElementById(id);
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play failed (user interaction needed)"));
        }

        // --- 2. KALENDER LOGIK (M√úLL & GEBURTSTAGE) ---
        function calcDaysUntil(dateStr) {
            if(!dateStr) return 999;
            const today = new Date();
            today.setHours(0,0,0,0);
            const bday = new Date(dateStr);
            bday.setFullYear(today.getFullYear());
            bday.setHours(0,0,0,0);
            if (bday < today) bday.setFullYear(today.getFullYear() + 1);
            const diffTime = Math.abs(bday - today);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        }

        function renderBirthdays() {
            const list = document.getElementById('birthdayList');
            const contacts = JSON.parse(localStorage.getItem('familyContacts')) || [];
            list.innerHTML = '';
            
            if(contacts.filter(c => c.bday).length === 0) {
                list.innerHTML = '<div class="card-padded" style="text-align:center; color:#999;">Keine Geburtstage eingetragen.</div>';
                return;
            }

            let upcoming = contacts.filter(c => c.bday).map(c => {
                return { ...c, days: calcDaysUntil(c.bday) };
            }).sort((a,b) => a.days - b.days).slice(0, 4);

            upcoming.forEach(c => {
                let dayText = c.days === 0 ? "HEUTE! üéâ" : c.days === 1 ? "Morgen" : `in ${c.days} Tagen`;
                let colorClass = c.days <= 7 ? 'color:var(--primary-blue); font-weight:bold;' : 'color:#8e8e93;';
                
                // Original Geburtsdatum formatieren
                let bDate = new Date(c.bday);
                let dateStr = bDate.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});

                list.innerHTML += `
                <div class="list-item" style="padding: 12px 15px;">
                    <div>
                        <strong>${c.name}</strong> <span style="font-size:12px; color:#ccc;">(${dateStr}.)</span>
                    </div>
                    <div style="${colorClass} font-size:14px;">${dayText}</div>
                </div>`;
            });
        }

        function renderTrash() {
            const div = document.getElementById('trashDisplay');
            const data = JSON.parse(localStorage.getItem('trashData')) || [];
            div.innerHTML = '';
            
            const todayStr = new Date().toISOString().split('T')[0].replace(/-/g,'');
            const nextTrash = data.filter(x => x.d >= todayStr).slice(0, 4);

            if(nextTrash.length > 0) {
                div.innerHTML = '<h3>M√ºllabfuhr üóëÔ∏è</h3><div class="card-container">';
                nextTrash.forEach(x => {
                    let color = '#8e8e93'; // Default Gray
                    if(x.s.includes('Bio') || x.s.includes('Braun')) color = '#8B4513';
                    if(x.s.includes('Papier') || x.s.includes('Blaue')) color = '#007aff';
                    if(x.s.includes('Gelb') || x.s.includes('Verpackung') || x.s.includes('Wert')) color = '#ffcc00';
                    if(x.s.includes('Rest') || x.s.includes('Grau')) color = '#333333';
                    
                    const dateFmt = `${x.d.slice(6,8)}.${x.d.slice(4,6)}.`;
                    
                    div.lastChild.innerHTML += `
                    <div class="list-item" style="padding: 12px 15px;">
                        <div style="display:flex; align-items:center;">
                            <span class="trash-indicator" style="background:${color}"></span>
                            <span>${x.s}</span>
                        </div>
                        <strong>${dateFmt}</strong>
                    </div>`;
                });
                div.innerHTML += '</div>';
            }
        }

        function updateTodayPreview() {
            const tasks = JSON.parse(localStorage.getItem('familyTasks')) || [];
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = tasks.filter(t => t.date === today && !t.done);
            const container = document.getElementById('todayTasksPreview');
            
            if(todayTasks.length > 0) {
                container.innerHTML = `<span style="color:var(--primary-blue); font-weight:bold;">${todayTasks.length} offene Aufgaben</span><br>Schau im Tab "Aufgaben" nach!`;
            } else {
                container.innerHTML = "Keine Aufgaben f√ºr heute f√§llig.";
            }
        }

        // --- 3. TASKS LOGIK ---
        function createTask() {
            const creator = document.getElementById('taskCreator').value;
            const assignee = document.getElementById('taskAssignee').value;
            const date = document.getElementById('taskDate').value;
            const text = document.getElementById('taskText').value;

            if(!creator || !assignee || !text) { alert("Bitte f√ºlle alle Felder aus."); return; }

            const newTask = { id: Date.now(), creator, assignee, date, text, done: false };
            let tasks = JSON.parse(localStorage.getItem('familyTasks')) || [];
            tasks.push(newTask);
            localStorage.setItem('familyTasks', JSON.stringify(tasks));

            document.getElementById('taskText').value = "";
            renderTasks();
            alert("Aufgabe gespeichert!");
        }

        function renderTasks() {
            const container = document.getElementById('taskListContainer');
            const tasks = JSON.parse(localStorage.getItem('familyTasks')) || [];
            container.innerHTML = '';

            // Sortieren: Datum aufsteigend
            tasks.sort((a,b) => {
                if(!a.date) return 1; if(!b.date) return -1;
                return new Date(a.date) - new Date(b.date);
            });

            const openTasks = tasks.filter(t => !t.done);

            if(openTasks.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#ccc;"><i class="fas fa-umbrella-beach" style="font-size:40px; margin-bottom:10px;"></i><br>Alles erledigt!</div>';
                return;
            }

            openTasks.forEach(task => {
                const dateDisplay = task.date ? new Date(task.date).toLocaleDateString('de-DE') : "Kein Datum";
                
                // Ist Datum √ºberschritten?
                const isOverdue = task.date && new Date(task.date) < new Date().setHours(0,0,0,0);
                const dateColor = isOverdue ? 'color:var(--danger-red); font-weight:bold;' : '';

                const html = `
                <div class="task-card">
                    <div class="task-header">
                        <span class="task-title">${task.text}</span>
                        <span class="badge">${task.assignee}</span>
                    </div>
                    <div class="task-meta">
                        <i class="far fa-clock"></i> <span style="${dateColor}">Bis: ${dateDisplay}</span> 
                        &bull; Von: ${task.creator}
                    </div>
                    <div class="task-actions">
                        <button class="sm-btn btn-delete" onclick="deleteTask(${task.id})"><i class="fas fa-trash"></i></button>
                        <button class="sm-btn btn-done" onclick="completeTask(${task.id})"><i class="fas fa-check"></i> Fertig</button>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function completeTask(id) {
            let tasks = JSON.parse(localStorage.getItem('familyTasks')) || [];
            const idx = tasks.findIndex(t => t.id === id);
            if(idx > -1) {
                tasks[idx].done = true;
                localStorage.setItem('familyTasks', JSON.stringify(tasks));
                renderTasks();
            }
        }

        function deleteTask(id) {
            if(prompt("PIN zum L√∂schen:") === DELETE_PIN) {
                let tasks = JSON.parse(localStorage.getItem('familyTasks')) || [];
                tasks = tasks.filter(t => t.id !== id);
                localStorage.setItem('familyTasks', JSON.stringify(tasks));
                renderTasks();
            }
        }

        // --- 4. KONTAKTE LOGIK ---
        function renderContacts() {
            const list = document.getElementById('contactsList');
            let contacts = JSON.parse(localStorage.getItem('familyContacts')) || [];
            list.innerHTML = '';
            
            contacts.sort((a,b) => a.name.localeCompare(b.name));

            contacts.forEach(c => {
                const bdayStr = c.bday ? new Date(c.bday).toLocaleDateString('de-DE') : '';
                const mapLink = `https://maps.google.com/?q=${encodeURIComponent(c.addr || '')}`;
                
                list.innerHTML += `
                <div class="card-container card-padded" style="margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <strong style="font-size:17px;">${c.name}</strong> <span style="color:#8e8e93; font-size:14px;">(${c.rel})</span>
                            <div style="font-size:13px; color:#666; margin-top:5px;">
                                ${c.bday ? `üéÇ ${bdayStr}<br>` : ''}
                                ${c.addr ? `<a href="${mapLink}" target="_blank" style="color:var(--primary-blue); text-decoration:none;">üìç ${c.addr}</a>` : ''}
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            ${c.phone ? `<a href="tel:${c.phone}" class="action-btn" style="width:40px; height:40px; padding:0; border-radius:20px; background:var(--success-green);"><i class="fas fa-phone"></i></a>` : ''}
                        </div>
                    </div>
                </div>`;
            });
        }

        function openContactModal() {
            const name = prompt("Name:");
            if(!name) return;
            const rel = prompt("Beziehung (z.B. Oma):");
            const bday = prompt("Geburtstag (YYYY-MM-DD):");
            const phone = prompt("Telefonnummer:");
            const addr = prompt("Adresse (f√ºr Maps):");
            
            let c = JSON.parse(localStorage.getItem('familyContacts')) || [];
            c.push({id: Date.now(), name, rel, bday, phone, addr});
            localStorage.setItem('familyContacts', JSON.stringify(c));
            renderContacts();
        }

        // --- 5. SETTINGS & DATEN-MANAGEMENT ---
        function saveFilter() { 
            localStorage.setItem('trashFilter', document.getElementById('filterInput').value);
            alert("Filter gespeichert!");
        }

        function importIcs(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            const filterStr = document.getElementById('filterInput').value || "";
            const filter = filterStr.toLowerCase().split(',').map(s=>s.trim()).filter(s => s !== "");

            reader.onload = function(f) {
                const lines = f.target.result.split(/\r?\n/);
                let events = [], cur = {};
                lines.forEach(l => {
                    if(l.startsWith('BEGIN:VEVENT')) cur = {};
                    if(l.startsWith('SUMMARY:')) cur.s = l.replace('SUMMARY:','').trim();
                    if(l.startsWith('DTSTART;VALUE=DATE:')) cur.d = l.replace('DTSTART;VALUE=DATE:','').trim(); // Fix f√ºr reine Datums-Events
                    else if(l.startsWith('DTSTART')) cur.d = (l.match(/\d{8}/) || [])[0];
                    
                    if(l.startsWith('END:VEVENT') && cur.s && cur.d) {
                        const sL = cur.s.toLowerCase();
                        // Wenn Filter leer ist: alles importieren. Wenn Filter da ist: Nur Matches importieren.
                        const matches = filter.length === 0 || filter.some(fil => sL.includes(fil));
                        
                        if(matches) events.push(cur);
                    }
                });
                
                // Duplikate vermeiden (einfacher Check)
                localStorage.setItem('trashData', JSON.stringify(events.sort((a,b)=>a.d.localeCompare(b.d))));
                document.getElementById('importStatus').innerText = `${events.length} Termine erfolgreich importiert!`;
                
                // Reset File Input
                e.target.value = '';
            };
            reader.readAsText(file);
        }

        function deleteCategory(key, label) {
            if(prompt(`PIN eingeben, um ${label} endg√ºltig zu l√∂schen:`) !== DELETE_PIN) {
                alert("Falsche PIN!");
                return;
            }

            if (key === 'ALL') {
                localStorage.clear();
                location.reload(); 
            } else {
                localStorage.removeItem(key);
                alert(`${label} wurden gel√∂scht.`);
                // UI Refresh
                if(key === 'familyTasks') renderTasks();
                if(key === 'familyContacts') { renderContacts(); renderBirthdays(); }
                if(key === 'trashData') { renderTrash(); document.getElementById('importStatus').innerText = ""; }
            }
        }
    </script>
</body>
</html>
